define(["lodash","app/core/utils/datemath","app/plugins/sdk"],function(__WEBPACK_EXTERNAL_MODULE__0__,__WEBPACK_EXTERNAL_MODULE__4__,__WEBPACK_EXTERNAL_MODULE__7__){return function(modules){var installedModules={};function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}return __webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{enumerable:!0,get:getter})},__webpack_require__.r=function(exports){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(exports,"__esModule",{value:!0})},__webpack_require__.t=function(value,mode){if(1&mode&&(value=__webpack_require__(value)),8&mode)return value;if(4&mode&&"object"==typeof value&&value&&value.__esModule)return value;var ns=Object.create(null);if(__webpack_require__.r(ns),Object.defineProperty(ns,"default",{enumerable:!0,value:value}),2&mode&&"string"!=typeof value)for(var key in value)__webpack_require__.d(ns,key,function(key){return value[key]}.bind(null,key));return ns},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=1)}([function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__0__},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AnnotationsQueryCtrl=exports.ConfigCtrl=exports.QueryCtrl=exports.Datasource=void 0;var _datasource2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(__webpack_require__(2)),_query_ctrl=__webpack_require__(6),_config_ctrl=__webpack_require__(8);var ChangeMyNameAnnotationsQueryCtrl=function(){function ChangeMyNameAnnotationsQueryCtrl(){}return ChangeMyNameAnnotationsQueryCtrl.templateUrl="partials/annotations.editor.html",ChangeMyNameAnnotationsQueryCtrl}();exports.Datasource=_datasource2.default,exports.QueryCtrl=_query_ctrl.AtsdQueryCtrl,exports.ConfigCtrl=_config_ctrl.ChangeMyNameConfigCtrl,exports.AnnotationsQueryCtrl=ChangeMyNameAnnotationsQueryCtrl},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DatasourceType=void 0;var _lodash2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(__webpack_require__(0)),_convertutils=__webpack_require__(3),_atsd_client=__webpack_require__(5);var __awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},__generator=function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=(t=_.trys).length>0&&t[t.length-1])&&(6===op[0]||2===op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},DatasourceType=exports.DatasourceType=void 0;!function(DatasourceType){DatasourceType[DatasourceType.ATSD=0]="ATSD",DatasourceType[DatasourceType.AS=1]="AS"}(DatasourceType||(exports.DatasourceType=DatasourceType={}));var AtsdDatasource=function(){function AtsdDatasource(instanceSettings,backendSrv,templateSrv,$q){this.backendSrv=backendSrv,this.templateSrv=templateSrv,this.$q=$q,this.client=new _atsd_client.AtsdClient(this.backendSrv,{proxyUrl:instanceSettings.url,basicAuth:instanceSettings.basicAuth})}return AtsdDatasource.$inject=["instanceSettings","backendSrv","templateSrv","$q"],Object.defineProperty(AtsdDatasource.prototype,"version",{get:function(){var _this=this;return this._version?this._version:(__awaiter(_this,void 0,void 0,function(){var _a;return __generator(this,function(_b){switch(_b.label){case 0:return _a=this,[4,this.client.version()];case 1:return _a._version=_b.sent(),[2]}})}),this._version)},enumerable:!0,configurable:!0}),AtsdDatasource.prototype.query=function(options){var _this=this,start=(0,_convertutils._convertToAtsdTime)(options.range.from),end=(0,_convertutils._convertToAtsdTime)(options.range.to),qs=[];_lodash2.default.each(options.targets,function(target){target.disconnect=options.targets[0].disconnect,qs.push(_this._convertTargetToQuery(target))});var queries=_lodash2.default.compact(qs);if(_lodash2.default.isEmpty(queries)){var d=this.$q.defer();return d.resolve({data:[]}),d.promise}var groupByTags={};return _lodash2.default.each(queries,function(query){_lodash2.default.each(query.tags,function(val,key){groupByTags[key]=!0})}),this._performTimeSeriesQuery(queries,start,end).then(function(response){if(void 0===response.data)return{data:[]};var result=response.data.filter(function(s){return s&&s.tags&&!Object.keys(s.tags).map(function(k){return s.tags[k]}).every(function(v){return"*"===v})}).map(_convertutils._transformMetricData);return result.sort(function(a,b){var nameA=a.target.toLowerCase(),nameB=b.target.toLowerCase();return nameA<nameB?-1:nameA>nameB?1:0}),{data:result}})},AtsdDatasource.prototype._performTimeSeriesQuery=function(queries,start,end){var tsQueries=[];if(_lodash2.default.each(queries,function(query){if(""!==query.entity&&""!==query.metric)if(query.implicit)void 0!==query.tagCombos&&_lodash2.default.each(query.tagCombos,function(group){if(group.en){var tags_1={};_lodash2.default.each(group.data,function(value,key){tags_1[key]=[value]}),tsQueries.push({startDate:start,endDate:end,limit:1e4,entity:query.entity,metric:query.table?query.table+","+query.metric:query.metric,tags:tags_1,timeFormat:"milliseconds",aggregate:query.aggregation})}});else{var tags={};for(var k in query.tags)tags[k]=query.tags[k];tsQueries.push({startDate:start,endDate:end,limit:1e4,entity:query.entity,metric:query.table?query.table+","+query.metric:query.metric,tags:tags,timeFormat:"milliseconds",aggregate:query.aggregation})}}),0===tsQueries.length){var d=this.$q.defer();return d.resolve({data:void 0}),d.promise}return this.client.querySeries(tsQueries).catch(function(resp){return console.log(resp.data)})},AtsdDatasource.prototype.getEntities=function(){return this.client.entities()},AtsdDatasource.prototype.getMetrics=function(entity,table){return this.client.metrics(entity,table)},AtsdDatasource.prototype.getMetricSeries=function(metric){return this.client.metricSeries(metric)},AtsdDatasource.prototype.getVersion=function(){return this.client.version()},AtsdDatasource.prototype.getTables=function(entityName){return this.client.tables(entityName)},AtsdDatasource.prototype.testDatasource=function(){return this.client.version().then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},AtsdDatasource.prototype._convertTargetToQuery=function(target){return target.metric&&target.entity&&!target.hide?{entity:this.templateSrv.replace(target.entity),metric:this.templateSrv.replace(target.metric),aggregation:void 0!==target.aggregation.type?target.aggregation:void 0,tags:(0,_convertutils.convertTags)(target.tags),disconnect:void 0!==target.disconnect&&""!==target.disconnect?(0,_convertutils._convertToSeconds)((0,_convertutils._parsePeriod)(target.disconnect)):86400}:null},AtsdDatasource}();exports.default=AtsdDatasource},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports._convertToAtsdTime=function(date){return date="now"!==date?date:new Date,(date=(0,_datemath.parse)(date)).toISOString()},exports._parsePeriod=function(period){return{count:period.count,unit:period.unit}},exports._transformMetricData=function(metricData){var dps=_lodash2.default.map(metricData.data,function(item){return[item.v,item.t]}),name=metricData.entity+": "+metricData.metric;return _lodash2.default.each(metricData.tags,function(value,key){name+=", "+key+"="+value}),{target:name,datapoints:dps}},exports._convertToSeconds=function(interval){var count=interval.count;switch(interval.unit){case"YEAR":count*=31536e3;break;case"MONTH":count*=2592e3;break;case"WEEK":count*=604800;break;case"DAY":count*=86400;break;case"HOUR":count*=3600;break;case"MINUTE":count*=60;break;case"SECOND":break;default:count=0}return count},exports.convertTags=function(grafanaTags){var tags={};return grafanaTags.forEach(function(item){tags[item.key]?tags[item.key].push(item.value):tags[item.key]=[item.value]}),tags};var _datemath=__webpack_require__(4),_lodash2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(__webpack_require__(0))},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__4__},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},AtsdClient=function(){function AtsdClient(transport,baseSettings){this.transport=transport,this.baseSettings=baseSettings}return AtsdClient.prototype.metrics=function(entityName,tableName){var options={method:"GET",url:"entities/"+entityName+"/metrics",params:tableName?{table:tableName}:void 0};return this.baseRequest(options).then(function(arr){return arr instanceof Array?arr:[]})},AtsdClient.prototype.entities=function(){return this.baseRequest({method:"GET",url:"entities"}).then(function(arr){return arr instanceof Array?arr:[]})},AtsdClient.prototype.version=function(){return this.baseRequest({method:"GET",url:"version"}).catch(function(){throw new Error("Failed to execute test query!")})},AtsdClient.prototype.metricSeries=function(metricName){return this.baseRequest({method:"GET",url:"metrics/"+metricName+"/series"}).then(function(arr){return arr instanceof Array?arr:[]})},AtsdClient.prototype.querySeries=function(q){return this.transport.datasourceRequest(this.mixinBaseOptions({url:"series/query",method:"POST",data:q}))},AtsdClient.prototype.tables=function(entityName){return this.baseRequest({method:"GET",url:"entities/"+entityName+"/tables"}).then(function(arr){return arr instanceof Array?arr:[]})},AtsdClient.prototype.baseRequest=function(options){var cOptions=this.mixinBaseOptions(options);return this.transport.request(cOptions).then(function(resp){return resp})},AtsdClient.prototype.mixinBaseOptions=function(options){return __assign({},options,{headers:{basicAuth:this.baseSettings.basicAuth},url:this.fullUrl(options.url)})},AtsdClient.prototype.fullUrl=function(part){var url=this.baseSettings.proxyUrl,fullUrl="/"!==url[url.length-1]?url+"/":url;return part.length<=0||"/"!==part[0]||(part=part.substr(1,part.length-1)),fullUrl+AtsdClient.BASE_URL+part},AtsdClient.BASE_URL="api/v1/",AtsdClient}();exports.AtsdClient=AtsdClient},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AtsdQueryCtrl=void 0;var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_lodash2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(__webpack_require__(0)),_sdk=__webpack_require__(7);var __extends=function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},AtsdQueryCtrl=function(_super){function AtsdQueryCtrl($scope,$injector){var _this=_super.call(this,$scope,$injector)||this;if(_this.suggest={metrics:[],entities:[],tables:[],aggregation:{types:AtsdQueryCtrl.aggregateOptions(),period:{units:AtsdQueryCtrl.unitOptions()}},tags:{keys:[],values:[]}},_this.segments={tagEditor:{editIndex:void 0,key:void 0,value:void 0}},_this.state={isLoaded:!0,showAggregation:void 0,tagRow:{isEdit:!1,canAdd:!0,tags:[]}},_this.model=__assign({},_this.target),_this.model.table=void 0,_this.model.metric=void 0,"object"!==_typeof(_this.model.tags))_this.model.tags=[];else for(var i=0;i<_this.model.tags.length;i++)_this.state.tagRow.tags.push({selected:!1});return _this.model.entity=_this.model.entity?_this.model.entity:void 0,_this.model.metric=_this.model.metric?_this.model.metric:void 0,_this.model.aggregation=_this.model.aggregation?_this.model.aggregation:{type:_this.suggest.aggregation.types[0].value,period:{count:1,unit:_this.suggest.aggregation.period.units[3].value}},_this.suggest.entities=[],_this.datasource.getEntities().then(function(result){result.forEach(function(item){return _this.suggest.entities.push(item.name)}),_this.state.isLoaded=!1}).catch(function(err){return console.log(err)}),_this.datasource.getVersion().then(function(v){if(_this.state.showAggregation=!!v.buildInfo.hbaseVersion,_this.state.showAggregation||(_this.model.aggregation={type:_this.suggest.aggregation.types[0].value,period:{count:1,unit:_this.suggest.aggregation.period.units[3].value}}),_this.model.entity){if(_this.state.showAggregation)_this.model.metric=_this.target.metric;else{var commaPos=_this.target.metric.indexOf(",");commaPos>-1?(_this.model.table=_this.target.metric.substr(0,commaPos),_this.model.metric=_this.target.metric.substr(commaPos+1)):_this.model.metric=_this.target.metric}_this.entityBlur()}}),_this}return __extends(AtsdQueryCtrl,_super),AtsdQueryCtrl.$inject=["$scope","$injector"],AtsdQueryCtrl.prototype.refresh=function(){for(var _i=0,_a=Object.keys(this.model);_i<_a.length;_i++){var k=_a[_i];this.target[k]=this.model[k]}this.target.metric=this.model.metric&&this.model.table?this.model.table+","+this.model.metric:this.model.metric,_super.prototype.refresh.call(this)},AtsdQueryCtrl.aggregateOptions=function(){var aggregateTypes=[void 0,"Count","Min","Max","Avg","Median","Sum","Percentile_999","Percentile_995","Percentile_99","Percentile_95","Percentile_90","Percentile_75","First","Last","Delta","Wavg","Wtavg","Standard_deviation"];return _lodash2.default.map(aggregateTypes,function(item){return item?{label:item,value:item.toUpperCase()}:{label:"None",value:item}})},AtsdQueryCtrl.unitOptions=function(){return[{label:"MILLISECOND",value:"MILLISECOND"},{label:"SECOND",value:"SECOND"},{label:"MINUTE",value:"MINUTE"},{label:"HOUR",value:"HOUR"},{label:"DAY",value:"DAY"},{label:"WEEK",value:"WEEK"},{label:"MONTH",value:"MONTH"},{label:"QUARTER",value:"QUARTER"},{label:"YEAR",value:"YEAR"}]},AtsdQueryCtrl.prototype.entityBlur=function(){var _this=this;this.refresh(),this.model.entity&&void 0!==this.state.showAggregation&&(this.state.showAggregation||this.datasource.getTables(this.model.entity).then(function(tables){_this.suggest.tables=tables.map(function(t){return t.name}),_this.suggest.metrics=[]}),this.fetchSuggestMetric())},AtsdQueryCtrl.prototype.fetchSuggestMetric=function(){var _this=this;this.datasource.getMetrics(this.model.entity,this.model.table).then(function(result){_this.suggest.metrics=result.map(function(m){return m.name}),!1===_this.state.showAggregation&&_this.model.table&&(_this.suggest.metrics=_this.suggest.metrics.map(function(name){return name.substr(_this.model.table.length+1)}))})},AtsdQueryCtrl.prototype.tableBlur=function(){this.fetchSuggestMetric(),this.refresh(),this.suggestTags()},AtsdQueryCtrl.prototype.metricBlur=function(){this.refresh(),this.suggestTags()},AtsdQueryCtrl.prototype.tagRemove=function(index){this.model.tags.splice(index,1),this.segments.tagEditor.editIndex=void 0,this.refresh()},AtsdQueryCtrl.prototype.tagEdit=function(index){this.segments.tagEditor.editIndex=index,this.segments.tagEditor.key=this.model.tags[index].key,this.segments.tagEditor.value=this.model.tags[index].value,this.state.tagRow.tags[index].isEdit=!0,this.state.tagRow.isEdit=!0,this.state.tagRow.isEdit=!0},AtsdQueryCtrl.prototype.tagMouseover=function(index){this.state.tagRow.isEdit||(this.state.tagRow.tags[index].selected=!0)},AtsdQueryCtrl.prototype.tagMouseleave=function(index){this.state.tagRow.isEdit||(this.state.tagRow.tags[index].selected=!1)},AtsdQueryCtrl.prototype.saveTag=function(){var editorValue={key:this.segments.tagEditor.key,value:this.segments.tagEditor.value},index=this.segments.tagEditor.editIndex;void 0!==index?this.model.tags[index]=editorValue:(this.model.tags.push(editorValue),this.state.tagRow.tags.push({selected:!1})),void 0!==this.segments.tagEditor.editIndex&&(this.state.tagRow.tags[this.segments.tagEditor.editIndex].selected=!1),this.state.tagRow.isEdit=!1,this.state.tagRow.canAdd=!0,this.segments.tagEditor.key="",this.segments.tagEditor.value="",this.refresh()},AtsdQueryCtrl.prototype.removeAllTags=function(){this.closeTagEditor(),this.model.tags.length=0,this.refresh()},AtsdQueryCtrl.prototype.showTagEditor=function(index){void 0!==index&&(this.segments.tagEditor.key=this.model.tags[index].key,this.segments.tagEditor.value=this.model.tags[index].value,this.state.tagRow.tags[index].isEdit=!0),this.segments.tagEditor.editIndex=index,this.state.tagRow.isEdit=!0,this.state.tagRow.canAdd=!1,this.state.tagRow.isEdit=!0,this.suggestTags()},AtsdQueryCtrl.prototype.closeTagEditor=function(){void 0!==this.segments.tagEditor.editIndex&&(this.state.tagRow.tags[this.segments.tagEditor.editIndex].selected=!1),this.state.tagRow.isEdit=!1,this.state.tagRow.canAdd=!0,this.segments.tagEditor.key="",this.segments.tagEditor.value=""},AtsdQueryCtrl.prototype.suggestTags=function(){var _this=this;if(this.model.metric){var params={entity:void 0};this.model.entity&&(params.entity=this.model.entity),this.datasource.getMetricSeries(this.model.metric).then(function(series){_this.suggest.tags.keys.length=0,_this.suggest.tags.values.length=0,series.forEach(function(item){for(var key in item.tags){-1===_this.suggest.tags.keys.indexOf(key)&&_this.suggest.tags.keys.push(key);var value=item.tags[key];-1===_this.suggest.tags.values.indexOf(value)&&(_this.segments.tagEditor.key?key===_this.segments.tagEditor.key&&item.metric===_this.model.metric&&item.entity===_this.model.entity&&_this.suggest.tags.values.push(value):_this.suggest.tags.values.push(value))}})})}},AtsdQueryCtrl.templateUrl="partials/query.editor.html",AtsdQueryCtrl}(_sdk.QueryCtrl);exports.AtsdQueryCtrl=AtsdQueryCtrl},function(module,exports){module.exports=__WEBPACK_EXTERNAL_MODULE__7__},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var ChangeMyNameConfigCtrl=function(){function ChangeMyNameConfigCtrl($scope){}return ChangeMyNameConfigCtrl.templateUrl="partials/config.html",ChangeMyNameConfigCtrl}();exports.ChangeMyNameConfigCtrl=ChangeMyNameConfigCtrl}])});