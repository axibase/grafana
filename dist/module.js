define(["lodash","app/core/utils/datemath","app/plugins/sdk"],function(t,e,r){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=1)}([function(e,r){e.exports=t},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AnnotationsQueryCtrl=e.ConfigCtrl=e.QueryCtrl=e.Datasource=void 0;var n=function(t){return t&&t.__esModule?t:{default:t}}(r(2)),i=r(6),o=r(8),s=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}();e.Datasource=n.default,e.QueryCtrl=i.AtsdQueryCtrl,e.ConfigCtrl=o.ChangeMyNameConfigCtrl,e.AnnotationsQueryCtrl=s},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DatasourceType=void 0;var n=function(t){return t&&t.__esModule?t:{default:t}}(r(0)),i=r(3),o=r(5),s=e.DatasourceType=void 0;!function(t){t[t.ATSD=0]="ATSD",t[t.AS=1]="AS"}(s||(e.DatasourceType=s={}));var a=function(){function t(t,e,r,n){this.backendSrv=e,this.templateSrv=r,this.$q=n,this.client=new o.AtsdClient(this.backendSrv,{proxyUrl:t.url,basicAuth:t.basicAuth})}return t.$inject=["instanceSettings","backendSrv","templateSrv","$q"],Object.defineProperty(t.prototype,"version",{get:function(){return this._version?this._version:(function(t,e,r,n){new(r||(r=Promise))(function(i,o){function s(t){try{u(n.next(t))}catch(t){o(t)}}function a(t){try{u(n.throw(t))}catch(t){o(t)}}function u(t){t.done?i(t.value):new r(function(e){e(t.value)}).then(s,a)}u((n=n.apply(t,e||[])).next())})}(this,void 0,void 0,function(){var t;return function(t,e){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=(i=s.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=e.call(t,s)}catch(t){o=[6,t],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}(this,function(e){switch(e.label){case 0:return t=this,[4,this.client.version()];case 1:return t._version=e.sent(),[2]}})}),this._version)},enumerable:!0,configurable:!0}),t.prototype.query=function(t){var e=this,r=(0,i._convertToAtsdTime)(t.range.from),o=(0,i._convertToAtsdTime)(t.range.to),s=[];n.default.each(t.targets,function(r){r.disconnect=t.targets[0].disconnect,s.push(e._convertTargetToQuery(r))});var a=n.default.compact(s);if(n.default.isEmpty(a)){var u=this.$q.defer();return u.resolve({data:[]}),u.promise}var c={};return n.default.each(a,function(t){n.default.each(t.tags,function(t,e){c[e]=!0})}),this._performTimeSeriesQuery(a,r,o).then(function(t){if(void 0===t.data)return{data:[]};var e=t.data.filter(function(t){return t&&t.tags&&!Object.keys(t.tags).map(function(e){return t.tags[e]}).every(function(t){return"*"===t})}).map(i._transformMetricData);return e.sort(function(t,e){var r=t.target.toLowerCase(),n=e.target.toLowerCase();return r<n?-1:r>n?1:0}),{data:e}})},t.prototype._performTimeSeriesQuery=function(t,e,r){var i=[];if(n.default.each(t,function(t){if(""!==t.entity&&""!==t.metric)if(t.implicit)void 0!==t.tagCombos&&n.default.each(t.tagCombos,function(o){if(o.en){var s={};n.default.each(o.data,function(t,e){s[e]=[t]}),i.push({startDate:e,endDate:r,limit:1e4,entity:t.entity,metric:t.table?t.table+","+t.metric:t.metric,tags:s,timeFormat:"milliseconds",aggregate:t.aggregation})}});else{var o={};for(var s in t.tags)o[s]=t.tags[s];i.push({startDate:e,endDate:r,limit:1e4,entity:t.entity,metric:t.table?t.table+","+t.metric:t.metric,tags:o,timeFormat:"milliseconds",aggregate:t.aggregation})}}),0===i.length){var o=this.$q.defer();return o.resolve({data:void 0}),o.promise}return this.client.querySeries(i).catch(function(t){return console.log(t.data)})},t.prototype.getEntities=function(){return this.client.entities()},t.prototype.getMetrics=function(t,e){return this.client.metrics(t,e)},t.prototype.getMetricSeries=function(t){return this.client.metricSeries(t)},t.prototype.getVersion=function(){return this.client.version()},t.prototype.getTables=function(t){return this.client.tables(t)},t.prototype.testDatasource=function(){return this.client.version().then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},t.prototype._convertTargetToQuery=function(t){return t.metric&&t.entity&&!t.hide?{entity:this.templateSrv.replace(t.entity),metric:this.templateSrv.replace(t.metric),aggregation:void 0!==t.aggregation.type?t.aggregation:void 0,tags:(0,i.convertTags)(t.tags),disconnect:void 0!==t.disconnect&&""!==t.disconnect?(0,i._convertToSeconds)((0,i._parsePeriod)(t.disconnect)):86400}:null},t}();e.default=a},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._convertToAtsdTime=function(t){return t="now"!==t?t:new Date,(t=(0,n.parse)(t)).toISOString()},e._parsePeriod=function(t){return{count:t.count,unit:t.unit}},e._transformMetricData=function(t){var e=i.default.map(t.data,function(t){return[t.v,t.t]}),r=t.entity+": "+t.metric;return i.default.each(t.tags,function(t,e){r+=", "+e+"="+t}),{target:r,datapoints:e}},e._convertToSeconds=function(t){var e=t.count;switch(t.unit){case"YEAR":e*=31536e3;break;case"MONTH":e*=2592e3;break;case"WEEK":e*=604800;break;case"DAY":e*=86400;break;case"HOUR":e*=3600;break;case"MINUTE":e*=60;break;case"SECOND":break;default:e=0}return e},e.convertTags=function(t){var e={};return t.forEach(function(t){e[t.key]?e[t.key].push(t.value):e[t.key]=[t.value]}),e};var n=r(4),i=function(t){return t&&t.__esModule?t:{default:t}}(r(0))},function(t,r){t.exports=e},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},i=function(){function t(t,e){this.transport=t,this.baseSettings=e}return t.prototype.metrics=function(t,e){var r={method:"GET",url:"entities/"+t+"/metrics",params:e?{table:e}:void 0};return this.baseRequest(r).then(function(t){return t instanceof Array?t:[]})},t.prototype.entities=function(){return this.baseRequest({method:"GET",url:"entities"}).then(function(t){return t instanceof Array?t:[]})},t.prototype.version=function(){return this.baseRequest({method:"GET",url:"version"}).catch(function(){throw new Error("Failed to execute test query!")})},t.prototype.metricSeries=function(t){return this.baseRequest({method:"GET",url:"metrics/"+t+"/series"}).then(function(t){return t instanceof Array?t:[]})},t.prototype.querySeries=function(t){return this.transport.datasourceRequest(this.mixinBaseOptions({url:"series/query",method:"POST",data:t}))},t.prototype.tables=function(t){return this.baseRequest({method:"GET",url:"entities/"+t+"/tables"}).then(function(t){return t instanceof Array?t:[]})},t.prototype.baseRequest=function(t){var e=this.mixinBaseOptions(t);return this.transport.request(e).then(function(t){return t})},t.prototype.mixinBaseOptions=function(t){return n({},t,{headers:{basicAuth:this.baseSettings.basicAuth},url:this.fullUrl(t.url)})},t.prototype.fullUrl=function(e){var r=this.baseSettings.proxyUrl,n="/"!==r[r.length-1]?r+"/":r;return e.length<=0||"/"!==e[0]||(e=e.substr(1,e.length-1)),n+t.BASE_URL+e},t.BASE_URL="api/v1/",t}();e.AtsdClient=i},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AtsdQueryCtrl=void 0;var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(t){return t&&t.__esModule?t:{default:t}}(r(0)),o=r(7),s=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}(),a=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},u=function(t){function e(r,i){var o=t.call(this,r,i)||this;if(o.suggest={metrics:[],entities:[],tables:[],aggregation:{types:e.aggregateOptions(),period:{units:e.unitOptions()}},tags:{keys:[],values:[]}},o.segments={tagEditor:{editIndex:void 0,key:void 0,value:void 0}},o.state={isLoaded:!0,showAggregation:void 0,tagRow:{isEdit:!1,canAdd:!0,tags:[]}},o.model=a({},o.target),o.model.table=void 0,o.model.metric=void 0,"object"!==n(o.model.tags))o.model.tags=[];else for(var s=0;s<o.model.tags.length;s++)o.state.tagRow.tags.push({selected:!1});return o.model.entity=o.model.entity?o.model.entity:void 0,o.model.metric=o.model.metric?o.model.metric:void 0,o.model.aggregation=o.model.aggregation?o.model.aggregation:{type:o.suggest.aggregation.types[0].value,period:{count:1,unit:o.suggest.aggregation.period.units[3].value}},o.suggest.entities=[],o.datasource.getEntities().then(function(t){t.forEach(function(t){return o.suggest.entities.push(t.name)}),o.state.isLoaded=!1}).catch(function(t){return console.log(t)}),o.datasource.getVersion().then(function(t){if(o.state.showAggregation=!!t.buildInfo.hbaseVersion,o.state.showAggregation||(o.model.aggregation={type:o.suggest.aggregation.types[0].value,period:{count:1,unit:o.suggest.aggregation.period.units[3].value}}),o.model.entity){if(o.state.showAggregation)o.model.metric=o.target.metric;else{var e=o.target.metric.indexOf(",");e>-1?(o.model.table=o.target.metric.substr(0,e),o.model.metric=o.target.metric.substr(e+1)):o.model.metric=o.target.metric}o.entityBlur()}}),o}return s(e,t),e.$inject=["$scope","$injector"],e.prototype.refresh=function(){for(var e=0,r=Object.keys(this.model);e<r.length;e++){var n=r[e];this.target[n]=this.model[n]}this.target.metric=this.model.metric&&this.model.table?this.model.table+","+this.model.metric:this.model.metric,t.prototype.refresh.call(this)},e.aggregateOptions=function(){return i.default.map([void 0,"Count","Min","Max","Avg","Median","Sum","Percentile_999","Percentile_995","Percentile_99","Percentile_95","Percentile_90","Percentile_75","First","Last","Delta","Wavg","Wtavg","Standard_deviation"],function(t){return t?{label:t,value:t.toUpperCase()}:{label:"None",value:t}})},e.unitOptions=function(){return[{label:"MILLISECOND",value:"MILLISECOND"},{label:"SECOND",value:"SECOND"},{label:"MINUTE",value:"MINUTE"},{label:"HOUR",value:"HOUR"},{label:"DAY",value:"DAY"},{label:"WEEK",value:"WEEK"},{label:"MONTH",value:"MONTH"},{label:"QUARTER",value:"QUARTER"},{label:"YEAR",value:"YEAR"}]},e.prototype.entityBlur=function(){var t=this;this.refresh(),this.model.entity&&void 0!==this.state.showAggregation&&(this.state.showAggregation||this.datasource.getTables(this.model.entity).then(function(e){t.suggest.tables=e.map(function(t){return t.name}),t.suggest.metrics=[]}),this.fetchSuggestMetric())},e.prototype.fetchSuggestMetric=function(){var t=this;this.datasource.getMetrics(this.model.entity,this.model.table).then(function(e){t.suggest.metrics=e.map(function(t){return t.name}),!1===t.state.showAggregation&&t.model.table&&(t.suggest.metrics=t.suggest.metrics.map(function(e){return e.substr(t.model.table.length+1)}))})},e.prototype.tableBlur=function(){this.fetchSuggestMetric(),this.refresh(),this.suggestTags()},e.prototype.metricBlur=function(){this.refresh(),this.suggestTags()},e.prototype.tagRemove=function(t){this.model.tags.splice(t,1),this.segments.tagEditor.editIndex=void 0,this.refresh()},e.prototype.tagEdit=function(t){this.segments.tagEditor.editIndex=t,this.segments.tagEditor.key=this.model.tags[t].key,this.segments.tagEditor.value=this.model.tags[t].value,this.state.tagRow.tags[t].isEdit=!0,this.state.tagRow.isEdit=!0,this.state.tagRow.isEdit=!0},e.prototype.tagMouseover=function(t){this.state.tagRow.isEdit||(this.state.tagRow.tags[t].selected=!0)},e.prototype.tagMouseleave=function(t){this.state.tagRow.isEdit||(this.state.tagRow.tags[t].selected=!1)},e.prototype.saveTag=function(){var t={key:this.segments.tagEditor.key,value:this.segments.tagEditor.value},e=this.segments.tagEditor.editIndex;void 0!==e?this.model.tags[e]=t:(this.model.tags.push(t),this.state.tagRow.tags.push({selected:!1})),void 0!==this.segments.tagEditor.editIndex&&(this.state.tagRow.tags[this.segments.tagEditor.editIndex].selected=!1),this.state.tagRow.isEdit=!1,this.state.tagRow.canAdd=!0,this.segments.tagEditor.key="",this.segments.tagEditor.value="",this.refresh()},e.prototype.removeAllTags=function(){this.closeTagEditor(),this.model.tags.length=0,this.refresh()},e.prototype.showTagEditor=function(t){void 0!==t&&(this.segments.tagEditor.key=this.model.tags[t].key,this.segments.tagEditor.value=this.model.tags[t].value,this.state.tagRow.tags[t].isEdit=!0),this.segments.tagEditor.editIndex=t,this.state.tagRow.isEdit=!0,this.state.tagRow.canAdd=!1,this.state.tagRow.isEdit=!0,this.suggestTags()},e.prototype.closeTagEditor=function(){void 0!==this.segments.tagEditor.editIndex&&(this.state.tagRow.tags[this.segments.tagEditor.editIndex].selected=!1),this.state.tagRow.isEdit=!1,this.state.tagRow.canAdd=!0,this.segments.tagEditor.key="",this.segments.tagEditor.value=""},e.prototype.suggestTags=function(){var t=this;if(this.model.metric){this.model.entity&&this.model.entity,this.datasource.getMetricSeries(this.model.metric).then(function(e){t.suggest.tags.keys.length=0,t.suggest.tags.values.length=0,e.forEach(function(e){for(var r in e.tags){-1===t.suggest.tags.keys.indexOf(r)&&t.suggest.tags.keys.push(r);var n=e.tags[r];-1===t.suggest.tags.values.indexOf(n)&&(t.segments.tagEditor.key?r===t.segments.tagEditor.key&&e.metric===t.model.metric&&e.entity===t.model.entity&&t.suggest.tags.values.push(n):t.suggest.tags.values.push(n))}})})}},e.templateUrl="partials/query.editor.html",e}(o.QueryCtrl);e.AtsdQueryCtrl=u},function(t,e){t.exports=r},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t){}return t.templateUrl="partials/config.html",t}();e.ChangeMyNameConfigCtrl=n}])});
//# sourceMappingURL=module.js.map