define(["lodash","app/core/utils/datemath","app/plugins/sdk"],function(t,e,r){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(i,a,function(e){return t[e]}.bind(null,a));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=1)}([function(e,r){e.exports=t},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AnnotationsQueryCtrl=e.ConfigCtrl=e.QueryCtrl=e.Datasource=void 0;var i=function(t){return t&&t.__esModule?t:{default:t}}(r(2)),a=r(5),s=r(7),n=function(){function t(){}return t.templateUrl="partials/annotations.editor.html",t}();e.Datasource=i.default,e.QueryCtrl=a.AtsdQueryCtrl,e.ConfigCtrl=s.ChangeMyNameConfigCtrl,e.AnnotationsQueryCtrl=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){return t&&t.__esModule?t:{default:t}}(r(0)),a=r(3),s=function(){function t(t,e,r,i){this.backendSrv=e,this.templateSrv=r,this.$q=i,this.url=t.url,this.basicAuth=t.basicAuth,this.templateSrv=r,this.backendSrv=e}return t.$inject=["instanceSettings","backendSrv","templateSrv","$q"],t.prototype.query=function(t){var e=this,r=(0,a._convertToAtsdTime)(t.range.from),s=(0,a._convertToAtsdTime)(t.range.to),n=[];i.default.each(t.targets,function(r){r.disconnect=t.targets[0].disconnect,n.push(e._convertTargetToQuery(r))});var o=i.default.compact(n);if(i.default.isEmpty(o)){var u=this.$q.defer();return u.resolve({data:[]}),u.promise}var g={};return i.default.each(o,function(t){i.default.each(t.tags,function(t,e){g[e]=!0})}),this._performTimeSeriesQuery(o,r,s).then(function(t){if(void 0===t.data)return{data:[]};var e=t.data.map(a._transformMetricData);return e.sort(function(t,e){var r=t.target.toLowerCase(),i=e.target.toLowerCase();return r<i?-1:r>i?1:0}),{data:e}})},t.prototype._performTimeSeriesQuery=function(t,e,r){var a=[];if(i.default.each(t,function(t){if(""!==t.entity&&""!==t.metric)if(t.implicit)void 0!==t.tagCombos&&i.default.each(t.tagCombos,function(s){if(s.en){var n={};i.default.each(s.data,function(t,e){n[e]=[t]}),a.push({startDate:e,endDate:r,limit:1e4,entity:t.entity,metric:t.metric,tags:n,timeFormat:"milliseconds",aggregate:t.aggregation})}});else{var s={};for(var n in t.tags)s[n]=t.tags[n];a.push({startDate:e,endDate:r,limit:1e4,entity:t.entity,metric:t.metric,tags:s,timeFormat:"milliseconds",aggregate:t.aggregation})}}),0===a.length){var s=this.$q.defer();return s.resolve({data:void 0}),s.promise}var n={method:"POST",url:this.fullUrl("/api/v1/series/query"),data:a,headers:{Authorization:this.basicAuth}};return this.backendSrv.datasourceRequest(n).then(function(t){return t})},t.prototype.getEntities=function(t){var e={method:"GET",url:this.fullUrl("/api/v1/entities"),params:t,headers:{Authorization:this.basicAuth}};return this.httpRequest(e).then(function(t){return t.data})},t.prototype.getMetrics=function(t,e){var r={method:"GET",url:this.fullUrl("/api/v1/entities/"+t+"/metrics"),params:e,headers:{Authorization:this.basicAuth}};return this.httpRequest(r).then(function(t){return t.data})},t.prototype.getMetricSeries=function(t,e){var r={method:"GET",url:this.fullUrl("/api/v1/metrics/"+t+"/series"),params:e,headers:{Authorization:this.basicAuth}};return this.httpRequest(r).then(function(t){return t.data})},t.prototype.testDatasource=function(){var t={method:"POST",url:this.fullUrl("/api/v1/series/query"),data:[],headers:{Authorization:this.basicAuth}};return this.httpRequest(t).then(function(){return{status:"success",message:"Data source is working",title:"Success"}})},t.prototype.httpRequest=function(t){return t.cache||(t.cache=!0),this.backendSrv.datasourceRequest(t)},t.prototype.fullUrl=function(t){var e="/"!==this.url[this.url.length-1]?this.url+"/":this.url;return t.length<=0||"/"!==t[0]||(t=t.substr(1,t.length-1)),e+t},t.prototype._convertTargetToQuery=function(t){return t.metric&&t.entity&&!t.hide?{entity:this.templateSrv.replace(t.entity),metric:this.templateSrv.replace(t.metric),aggregation:void 0!==t.aggregation.type?t.aggregation:void 0,tags:(0,a.convertTags)(t.tags),disconnect:void 0!==t.disconnect&&""!==t.disconnect?(0,a._convertToSeconds)((0,a._parsePeriod)(t.disconnect)):86400}:null},t}();e.default=s},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._convertToAtsdTime=function(t){return t="now"!==t?t:new Date,(t=(0,i.parse)(t)).toISOString()},e._parsePeriod=function(t){return{count:t.count,unit:t.unit}},e._transformMetricData=function(t){var e=a.default.map(t.data,function(t){return[t.v,t.t]}),r=t.entity+": "+t.metric;return a.default.each(t.tags,function(t,e){r+=", "+e+"="+t}),{target:r,datapoints:e}},e._convertToSeconds=function(t){var e=t.count;switch(t.unit){case"YEAR":e*=31536e3;break;case"MONTH":e*=2592e3;break;case"WEEK":e*=604800;break;case"DAY":e*=86400;break;case"HOUR":e*=3600;break;case"MINUTE":e*=60;break;case"SECOND":break;default:e=0}return e},e.convertTags=function(t){var e={};return t.forEach(function(t){e[t.key]?e[t.key].push(t.value):e[t.key]=[t.value]}),e};var i=r(4),a=function(t){return t&&t.__esModule?t:{default:t}}(r(0))},function(t,r){t.exports=e},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AtsdQueryCtrl=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=function(t){return t&&t.__esModule?t:{default:t}}(r(0)),s=r(6),n=function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),o=function(t){function e(r,a){var s=t.call(this,r,a)||this;if(s.suggest={metrics:[],entities:[],aggregation:{types:e.aggregateOptions(),period:{units:e.unitOptions()}},tags:{keys:[],values:[]}},s.segments={tagEditor:{editIndex:void 0,key:void 0,value:void 0}},s.state={isLoaded:!0,tagRow:{isEdit:!1,canAdd:!0,tags:[]}},s.target.entity&&s.entityBlur(),"object"!==i(s.target.tags))s.target.tags=[];else for(var n=0;n<s.target.tags.length;n++)s.state.tagRow.tags.push({selected:!1});return s.target.entity=s.target.entity?s.target.entity:void 0,s.target.metric=s.target.metric?s.target.metric:void 0,s.target.aggregation=s.target.aggregation?s.target.aggregation:{type:s.suggest.aggregation.types[0].value,period:{count:1,unit:s.suggest.aggregation.period.units[3].value}},s.suggest.entities=[],s.datasource.getEntities({}).then(function(t){t.forEach(function(t){return s.suggest.entities.push(t.name)}),s.state.isLoaded=!1}).catch(function(){return console.log("Failed to retrieve entities")}),s}return n(e,t),e.$inject=["$scope","$injector"],e.aggregateOptions=function(){return a.default.map([void 0,"Count","Min","Max","Avg","Median","Sum","Percentile_999","Percentile_995","Percentile_99","Percentile_95","Percentile_90","Percentile_75","First","Last","Delta","Wavg","Wtavg","Standard_deviation"],function(t){return t?{label:t,value:t.toUpperCase()}:{label:"None",value:t}})},e.unitOptions=function(){return[{label:"MILLISECOND",value:"MILLISECOND"},{label:"SECOND",value:"SECOND"},{label:"MINUTE",value:"MINUTE"},{label:"HOUR",value:"HOUR"},{label:"DAY",value:"DAY"},{label:"WEEK",value:"WEEK"},{label:"MONTH",value:"MONTH"},{label:"QUARTER",value:"QUARTER"},{label:"YEAR",value:"YEAR"}]},e.prototype.entityBlur=function(){var t=this;this.refresh(),this.target.entity&&this.datasource.getMetrics(this.target.entity,{}).then(function(e){t.suggest.metrics=[],e instanceof Array&&e.forEach(function(e){t.suggest.metrics.push(e.name)})})},e.prototype.metricBlur=function(){this.refresh(),this.suggestTags()},e.prototype.tagRemove=function(t){this.target.tags.splice(t,1),this.segments.tagEditor.editIndex=void 0,this.refresh()},e.prototype.tagEdit=function(t){this.segments.tagEditor.editIndex=t,this.segments.tagEditor.key=this.target.tags[t].key,this.segments.tagEditor.value=this.target.tags[t].value,this.state.tagRow.tags[t].isEdit=!0,this.state.tagRow.isEdit=!0,this.state.tagRow.isEdit=!0},e.prototype.tagMouseover=function(t){this.state.tagRow.isEdit||(this.state.tagRow.tags[t].selected=!0)},e.prototype.tagMouseleave=function(t){this.state.tagRow.isEdit||(this.state.tagRow.tags[t].selected=!1)},e.prototype.saveTag=function(){var t={key:this.segments.tagEditor.key,value:this.segments.tagEditor.value},e=this.segments.tagEditor.editIndex;void 0!==e?this.target.tags[e]=t:(this.target.tags.push(t),this.state.tagRow.tags.push({selected:!1})),void 0!==this.segments.tagEditor.editIndex&&(this.state.tagRow.tags[this.segments.tagEditor.editIndex].selected=!1),this.state.tagRow.isEdit=!1,this.state.tagRow.canAdd=!0,this.segments.tagEditor.key="",this.segments.tagEditor.value="",this.refresh()},e.prototype.removeAllTags=function(){this.closeTagEditor(),this.target.tags.length=0,this.refresh()},e.prototype.showTagEditor=function(t){void 0!==t&&(this.segments.tagEditor.key=this.target.tags[t].key,this.segments.tagEditor.value=this.target.tags[t].value,this.state.tagRow.tags[t].isEdit=!0),this.segments.tagEditor.editIndex=t,this.state.tagRow.isEdit=!0,this.state.tagRow.canAdd=!1,this.state.tagRow.isEdit=!0,this.suggestTags()},e.prototype.closeTagEditor=function(){void 0!==this.segments.tagEditor.editIndex&&(this.state.tagRow.tags[this.segments.tagEditor.editIndex].selected=!1),this.state.tagRow.isEdit=!1,this.state.tagRow.canAdd=!0,this.segments.tagEditor.key="",this.segments.tagEditor.value=""},e.prototype.suggestTags=function(){var t=this;if(this.target.metric){var e={entity:void 0};this.target.entity&&(e.entity=this.target.entity),this.datasource.getMetricSeries(this.target.metric,e).then(function(e){t.suggest.tags.keys.length=0,t.suggest.tags.values.length=0,e.forEach(function(e){for(var r in e.tags){-1===t.suggest.tags.keys.indexOf(r)&&t.suggest.tags.keys.push(r);var i=e.tags[r];-1===t.suggest.tags.values.indexOf(i)&&(t.segments.tagEditor.key?r===t.segments.tagEditor.key&&e.metric===t.target.metric&&e.entity===t.target.entity&&t.suggest.tags.values.push(i):t.suggest.tags.values.push(i))}})})}},e.templateUrl="partials/query.editor.html",e}(s.QueryCtrl);e.AtsdQueryCtrl=o},function(t,e){t.exports=r},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t){}return t.templateUrl="partials/config.html",t}();e.ChangeMyNameConfigCtrl=i}])});
//# sourceMappingURL=module.js.map